<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <link rel="icon" href="../assets/favicon.png" type="image/png"/>
  <link rel="stylesheet" href="../styles/styles.css"/>

  <!-- Patch UI v2 -->
  <link rel="stylesheet" href="../css/asd-tabs-override-v2.css?v=2"/>

  <title>Calendario — ASD</title>

  <style>
    /* Toolbar */
    .cal-toolbar { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin:0 0 12px 0 }
    .cal-toolbar .spacer { flex:1 1 auto; }

    /* Pannello ANNO */
    .year-panel {
      display:none;
      gap:8px;
      align-items:center;
      margin:8px 0 14px 0;
      padding:10px;
      border-radius:12px;
      background: rgba(0,0,0,.25);
    }
    .year-panel.is-open { display:flex; }

    .months-grid {
      display:grid;
      grid-template-columns: repeat(6, minmax(90px, 1fr));
      gap:8px;
      width:100%;
    }
    .month-btn {
      padding:10px 8px;
      border-radius:10px;
      border:0;
      font-weight:600;
      cursor:pointer;
    }
    .month-btn:hover { filter: brightness(1.06); }

    .nav-btn {
      padding:8px 10px;
      border-radius:10px;
      border:0;
      font-weight:600;
      cursor:pointer;
    }
  </style>
</head>
<body>
  <div class="page">
    <a class="back" href="../index.html">← Torna alla home</a>

    <div class="brand">
      <img class="brand-logo" src="../assets/logo.png" alt="Logo ASD Santi Pietro e Paolo" />
      <div class="brand-title">
        <h1>Calendario attività</h1>
        <div class="brand-sub">ASD Santi Pietro e Paolo</div>
      </div>
    </div>

    <div class="card">
      <p>Calendario allenamenti e partite</p>

      <!-- TOOLBAR -->
      <div class="cal-toolbar">
        <button class="btn" id="btn-day"   type="button">Giorno (Agenda)</button>
        <button class="btn" id="btn-week"  type="button">Settimana</button>
        <button class="btn" id="btn-month" type="button">Mese</button>
        <button class="btn" id="btn-year"  type="button">Anno</button>

        <!-- Scorrimento mesi attivo in vista Mese -->
        <span class="spacer"></span>
        <button class="nav-btn" id="btn-prev" title="Mese precedente">←</button>
        <button class="nav-btn" id="btn-next" title="Mese successivo">→</button>

        <a id="openCalendarFull" class="btn" href="#">Schermo intero</a>
      </div>

      <!-- PANNELLO ANNO (griglia 12 mesi + selettore anno) -->
      <div id="yearPanel" class="year-panel" aria-hidden="true">
        <label for="yearSelect" style="font-weight:700;">Anno:</label>
        <select id="yearSelect"></select>
        <div class="months-grid" id="monthsGrid"></div>
      </div>

      <!-- IFRAME responsivo -->
      <div style="position:relative;padding-bottom:56.25%;height:0;overflow:hidden;border-radius:12px">
        <iframe 
          id="calendar-embed"
          src=""
          style="border:0;position:absolute;top:0;left:0;width:100%;height:100%;border-radius:12px;" 
          frameborder="0" scrolling="no">
        </iframe>
      </div>
    </div>
  </div>

  <!-- Modale full-screen -->
  <div id="asd-modal" class="asd-modal" aria-hidden="true">
    <div class="asd-modal__inner">
      <button type="button" class="asd-modal__close" aria-label="Chiudi">✕</button>
      <div class="asd-modal__body"></div>
    </div>
  </div>

  <!-- JS patch v2 -->
  <script src="../js/asd-modal-v2.js?v=2" defer></script>

  <!-- JS locale -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // ======= CONFIG BASE EMBED =======
      const BASE = "https://calendar.google.com/calendar/embed";
      const CAL  = "29d83543be0fbbe269fcc9cb7018d6356%40group.calendar.google.com";
      const COMMON = "ctz=Europe%2FRome&showTitle=0&showPrint=0&showTabs=1&showDate=1&showNav=1&showCalendars=0";
      // Modal refs
      const modal = document.getElementById('asd-modal');
      const modalBody = modal.querySelector('.asd-modal__body');
      const iframe = document.getElementById('calendar-embed');

      // Stato corrente
      const today = new Date();
      const state = {
        view: 'WEEK',                  // 'AGENDA' | 'WEEK' | 'MONTH'
        year: today.getFullYear(),
        month: today.getMonth(),       // 0..11
        day: today.getDate()
      };

      // Helpers
      const pad = n => n.toString().padStart(2, '0');
      const yyyymmdd = (d) => d.getFullYear() + pad(d.getMonth()+1) + pad(d.getDate());
      function urlFor(view, d) {
        // d = Date oggetto; uso 'dates=YYYYMMDD' per puntare un giorno dentro al mese/settimana
        const dateStr = yyyymmdd(d);
        return `${BASE}?src=${CAL}&${COMMON}&mode=${view}&dates=${dateStr}`;
      }
      function updateIframe() {
        const d = new Date(state.year, state.month, Math.min(state.day, 28)); // day safe
        iframe.src = urlFor(state.view, d);
        // mostra/nascondi i bottoni prev/next solo in vista Mese
        document.getElementById('btn-prev').style.display = state.view === 'MONTH' ? 'inline-block' : 'none';
        document.getElementById('btn-next').style.display = state.view === 'MONTH' ? 'inline-block' : 'none';
      }
      function setView(view) {
        state.view = view;
        updateIframe();
      }
      function gotoMonth(y, m) {
        state.year = y; state.month = m; state.day = 1; state.view = 'MONTH';
        updateIframe();
      }
      function addMonths(delta) {
        const d = new Date(state.year, state.month + delta, 1);
        state.year = d.getFullYear(); state.month = d.getMonth(); state.day = 1;
        updateIframe();
      }

      // Inizializza
      updateIframe();

      // Bottoni vista
      document.getElementById('btn-day').addEventListener('click',  () => setView('AGENDA'));
      document.getElementById('btn-week').addEventListener('click', () => setView('WEEK'));
      document.getElementById('btn-month').addEventListener('click', () => setView('MONTH'));

      // Pannello Anno
      const yearPanel = document.getElementById('yearPanel');
      const yearSelect = document.getElementById('yearSelect');
      const monthsGrid = document.getElementById('monthsGrid');

      // Popola selettore anni (corrente ± 3)
      const baseYear = today.getFullYear();
      for (let y = baseYear - 3; y <= baseYear + 3; y++) {
        const opt = document.createElement('option');
        opt.value = y; opt.textContent = y;
        if (y === state.year) opt.selected = true;
        yearSelect.appendChild(opt);
      }

      // Popola mesi
      const mesi = ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];
      mesi.forEach((mName, mIdx) => {
        const b = document.createElement('button');
        b.type = 'button';
        b.className = 'month-btn';
        b.textContent = mName;
        b.addEventListener('click', () => gotoMonth(parseInt(yearSelect.value,10), mIdx));
        monthsGrid.appendChild(b);
      });

      document.getElementById('btn-year').addEventListener('click', () => {
        yearPanel.classList.toggle('is-open');
      });
      yearSelect.addEventListener('change', () => {
        // non cambia vista finché non scegli un mese
      });

      // Scorrimento mesi (solo in vista Mese)
      document.getElementById('btn-prev').addEventListener('click', () => addMonths(-1));
      document.getElementById('btn-next').addEventListener('click', () => addMonths(1));

      // Modale full-screen (mantiene la vista corrente)
      document.getElementById('openCalendarFull').addEventListener('click', function (e) {
        e.preventDefault();
        const d = new Date(state.year, state.month, Math.min(state.day, 28));
        const src = urlFor(state.view, d);
        modalBody.innerHTML = `<iframe src="${src}" width="100%" height="100%" frameborder="0"></iframe>`;
        modal.classList.add('is-open');
        document.documentElement.style.overflow = 'hidden';
      });
    });
  </script>
</body>
</html>


